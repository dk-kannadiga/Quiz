<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Knowledge Challenge Quiz</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .timer-warning {
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    button {
      pointer-events: auto !important;
      cursor: pointer !important;
    }
    .cursor-pointer {
      cursor: pointer !important;
      pointer-events: auto !important;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-purple-600 via-blue-600 to-indigo-800 min-h-screen">
  <!-- Admin Portal Toggle Button -->
  <div class="fixed top-4 right-4 z-50">
    <button onclick="showAdminLogin()" class="bg-white/20 backdrop-blur-sm text-white px-4 py-2 rounded-lg hover:bg-white/30 transition-all">
      üîß ‡≤®‡≤ø‡≤∞‡≥ç‡≤µ‡≤π‡≤£‡≥Ü ‡≤ï‡≥ã‡≤£‡≥Ü
    </button>
  </div>

  <!-- Admin Login Modal -->
  <div id="adminLoginModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full">
        <div class="p-6 border-b border-gray-200">
          <div class="flex justify-between items-center">
            <h2 class="text-2xl font-bold text-gray-800">üîê Admin Login</h2>
            <button onclick="closeAdminLogin()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
          </div>
        </div>
        <div class="p-6">
          <form id="adminLoginForm" class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-2">Admin Password</label>
              <input type="password" id="adminPassword" required class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Enter admin password">
            </div>
            <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition-all">
              Access Admin Portal
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Registration Form (main registration screen)-->
  <div id="registrationScreen" class="hidden bg-white/10 backdrop-blur-lg rounded-3xl shadow-2xl max-w-2xl w-full p-8 fade-in mx-auto mt-20">
    <h2 class="text-3xl font-bold text-white mb-8 text-center">üìù Registration</h2>
    <form id="registrationForm" class="space-y-6">
      <div>
        <label class="block text-white font-medium mb-2">Full Name *</label>
        <input type="text" id="participantName" required class="w-full p-4 rounded-xl border-0 bg-white/20 text-white placeholder-white/70 focus:bg-white/30 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Enter your full name">
      </div>
      <div>
        <label class="block text-white font-medium mb-2">Email Address *</label>
        <input type="email" id="participantEmail" required class="w-full p-4 rounded-xl border-0 bg-white/20 text-white placeholder-white/70 focus:bg-white/30 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Enter your email">
      </div>
      <div>
        <label class="block text-white font-medium mb-2">Phone Number *</label>
        <input type="tel" id="participantPhone" required class="w-full p-4 rounded-xl border-0 bg-white/20 text-white placeholder-white/70 focus:bg-white/30 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Enter your phone number">
      </div>
      <div id="postalAddressField" class="hidden">
        <label class="block text-white font-medium mb-2">Postal Address *</label>
        <textarea id="participantAddress" rows="3" class="w-full p-4 rounded-xl border-0 bg-white/20 text-white placeholder-white/70 focus:bg-white/30 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Enter your complete postal address"></textarea>
      </div>
      <button type="submit" class="w-full bg-gradient-to-r from-green-500 to-blue-600 text-white py-4 rounded-2xl text-xl font-semibold hover:from-green-600 hover:to-blue-700 transform hover:scale-105 transition-all shadow-lg">
        Continue to Quiz üéØ
      </button>
    </form>
  </div>

  <!-- Quiz Container (beginning of quiz flow screens) -->
  <div id="quizContainer" class="min-h-screen flex items-center justify-center p-4">
      
    <!-- Welcome Screen -->
    <div id="welcomeScreen" class="bg-white/10 backdrop-blur-lg rounded-3xl shadow-2xl max-w-2xl w-full p-8 text-center fade-in">
      <div class="mb-6">
        <div id="quizCreative" class="bg-gradient-to-r from-yellow-400 to-orange-500 rounded-2xl p-8 mb-6">
          <h1 class="text-4xl font-bold text-white mb-4" id="welcomeTitle">üß† Knowledge Challenge Quiz</h1>
          <p class="text-white/90 text-lg">Test your knowledge and win exciting prizes!</p>
          <div class="mt-4 p-4 bg-white/20 rounded-lg text-sm text-white/80">
            <p><strong>Terms & Conditions:</strong></p>
            <p>‚Ä¢ Quiz must be completed within the time limit</p>
            <p>‚Ä¢ Each question has a 10-second timer</p>
            <p>‚Ä¢ Results will be shared via email</p>
            <p>‚Ä¢ Prizes subject to availability</p>
          </div>
        </div>
      </div>
      <button onclick="startQuiz()" class="bg-gradient-to-r from-green-500 to-blue-600 text-white px-8 py-4 rounded-2xl text-xl font-semibold hover:from-green-600 hover:to-blue-700 transform hover:scale-105 transition-all shadow-lg">
        Continue to Quiz üöÄ
      </button>
    </div>
    <!-- Quiz Question Screen -->
    <div id="questionScreen" class="hidden bg-white/10 backdrop-blur-lg rounded-3xl shadow-2xl max-w-3xl w-full p-8 fade-in">
      <div class="flex justify-between items-center mb-6">
        <div class="text-white">
          <span class="text-lg">Question <span id="currentQuestionNum">1</span> of <span id="totalQuestions">5</span></span>
        </div>
        <div class="flex items-center space-x-4">
          <div id="timerDisplay" class="bg-red-500 text-white px-4 py-2 rounded-full font-bold text-lg">
            ‚è∞ <span id="timeLeft">10</span>s
          </div>
        </div>
      </div>
      
      <div class="mb-8">
        <h3 id="questionText" class="text-2xl font-bold text-white mb-6">What is the capital of France?</h3>
        <div id="optionsContainer" class="space-y-4">
          <!-- Options will be populated here -->
        </div>
      </div>

      <div class="flex justify-between">
        <button onclick="skipQuestion()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl font-semibold transition-all">
          Skip Question ‚è≠Ô∏è
        </button>
        <button onclick="submitAnswer()" class="bg-gradient-to-r from-green-500 to-blue-600 hover:from-green-600 hover:to-blue-700 text-white px-8 py-3 rounded-xl font-semibold transition-all">
          Submit Answer ‚úÖ
        </button>
      </div>
    </div>

    <!-- Thank You Screen -->
    <div id="thankYouScreen" class="hidden bg-white/10 backdrop-blur-lg rounded-3xl shadow-2xl max-w-2xl w-full p-8 text-center fade-in">
      <div class="mb-6">
        <div class="text-6xl mb-4">üéâ</div>
        <h2 class="text-3xl font-bold text-white mb-4">Thank You for Participating!</h2>
        <div class="bg-white/20 rounded-2xl p-6 text-white">
          <p class="text-lg mb-4">Your answers have been recorded successfully.</p>
          <p class="mb-2">Your E-Certificate will be shared to your provided email on:</p>
          <p class="text-xl font-bold text-yellow-300" id="certificateDate">December 31, 2024 at 11:59 PM</p>
        </div>
      </div>
      <button onclick="restartQuiz()" class="bg-gradient-to-r from-purple-500 to-pink-600 text-white px-8 py-4 rounded-2xl text-xl font-semibold hover:from-purple-600 hover:to-pink-700 transform hover:scale-105 transition-all shadow-lg">
        Take Another Quiz üîÑ
      </button>
    </div>

    <!-- Popup Modal (for missing answer selection) -->
    <div id="popupModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center">
      <div class="bg-white rounded-2xl p-6 max-w-md mx-4 shadow-2xl">
        <div class="text-center">
          <div class="text-4xl mb-4">‚ö†Ô∏è</div>
          <h3 class="text-xl font-bold mb-4">Please Select an Option</h3>
          <p class="text-gray-600 mb-6">You need to select an answer before submitting.</p>
          <button onclick="closePopup()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-semibold">
            Got it!
          </button>
        </div>
      </div>
    </div>
    <!-- Admin Portal -->
    <div id="adminPortal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-40">
      <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
          <div class="p-6 border-b border-gray-200">
            <div class="flex justify-between items-center">
              <h2 class="text-2xl font-bold text-gray-800">Quiz Admin Portal</h2>
              <button onclick="toggleAdminPortal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
          </div>
          <div class="p-6 space-y-6">

            <!-- Quiz Settings -->
            <div class="bg-gray-50 p-4 rounded-lg">
              <h3 class="text-lg font-semibold mb-4">Quiz Settings</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium mb-2">Quiz Title</label>
                  <input type="text" id="quizTitle" value="Knowledge Challenge Quiz" class="w-full p-2 border rounded-lg">
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">Timer per Question (seconds)</label>
                  <input type="number" id="questionTimer" value="10" min="5" max="60" class="w-full p-2 border rounded-lg">
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">End Date</label>
                  <input type="date" id="endDate" class="w-full p-2 border rounded-lg">
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">End Time</label>
                  <input type="time" id="endTime" class="w-full p-2 border rounded-lg">
                </div>
              </div>
              <div class="mt-4">
                <label class="flex items-center">
                  <input type="checkbox" id="requirePostalAddress" class="mr-2">
                  <span class="text-sm font-medium">Require Postal Address (Physical Prize)</span>
                </label>
              </div>
            </div>

            <!-- Creative Upload -->
            <div class="bg-gray-50 p-4 rounded-lg">
              <h3 class="text-lg font-semibold mb-4">Quiz Creative &amp; T&amp;C</h3>
              <div>
                <label class="block text-sm font-medium mb-2">Upload Creative Image</label>
                <input type="file" id="creativeUpload" accept="image/*" class="w-full p-2 border rounded-lg">
                <p class="text-xs text-gray-500 mt-1">Upload an image that includes your quiz creative and terms &amp; conditions</p>
              </div>
            </div>

            <!-- Questions Management -->
            <div class="bg-gray-50 p-4 rounded-lg">
              <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Questions</h3>
                <button onclick="addQuestion()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Add Question</button>
              </div>
              <div id="questionsContainer" class="space-y-4">
                <!-- Questions will be added here -->
              </div>
            </div>

            <!-- Results Management -->
            <div class="bg-gray-50 p-4 rounded-lg">
              <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Quiz Results</h3>
                <div class="space-x-2">
                  <button onclick="viewResults()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">View Results</button>
                  <button onclick="exportResults()" class="bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700">Export CSV</button>
                  <button onclick="clearResults()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">Clear All</button>
                </div>
              </div>
              <div id="resultsStats" class="grid grid-cols-3 gap-4 text-center">
                <div class="bg-blue-100 p-3 rounded">
                  <div class="text-2xl font-bold text-blue-600" id="totalParticipants">0</div>
                  <div class="text-sm text-gray-600">Total Participants</div>
                </div>
                <div class="bg-green-100 p-3 rounded">
                  <div class="text-2xl font-bold text-green-600" id="averageScore">0%</div>
                  <div class="text-sm text-gray-600">Average Score</div>
                </div>
                <div class="bg-purple-100 p-3 rounded">
                  <div class="text-2xl font-bold text-purple-600" id="completionRate">0%</div>
                  <div class="text-sm text-gray-600">Completion Rate</div>
                </div>
              </div>
            </div>

            <!-- Google Sheets Integration -->
            <div class="bg-gray-50 p-4 rounded-lg">
              <h3 class="text-lg font-semibold mb-4">Google Sheets Integration</h3>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium mb-2">Google Sheets Web App URL</label>
                  <input type="url" id="googleSheetsUrl" placeholder="https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec" class="w-full p-2 border rounded-lg">
                  <p class="text-xs text-gray-500 mt-1">Enter your Google Apps Script Web App URL to automatically save results to Google Sheets</p>
                </div>
                <div class="flex space-x-2">
                  <button onclick="testGoogleSheets()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Test Connection</button>
                  <button onclick="showGoogleSheetsSetup()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">Setup Instructions</button>
                </div>
              </div>
            </div>

            <!-- Save Settings -->
            <div class="flex justify-end space-x-4">
              <button onclick="saveQuizSettings()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">Save Quiz Settings</button>
              <button onclick="previewQuiz()" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700">Preview Quiz</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Results Modal -->
    <div id="resultsModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50">
      <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-6xl w-full max-h-[90vh] overflow-y-auto">
          <div class="p-6 border-b border-gray-200">
            <div class="flex justify-between items-center">
              <h2 class="text-2xl font-bold text-gray-800">Quiz Results Dashboard</h2>
              <button onclick="closeResultsModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
          </div>
          <div class="p-6">
            <div id="resultsContent" class="space-y-6">
              <!-- Results will be populated here -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Google Sheets Setup Modal -->
    <div id="googleSheetsModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50">
      <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
          <div class="p-6 border-b border-gray-200">
            <div class="flex justify-between items-center">
              <h2 class="text-2xl font-bold text-gray-800">üìä Google Sheets Setup Instructions</h2>
              <button onclick="closeGoogleSheetsModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
          </div>
          <div class="p-6 space-y-6">
            <div class="bg-blue-50 p-4 rounded-lg">
              <h3 class="font-bold text-blue-800 mb-2">üìã Step-by-Step Setup Guide</h3>
              <p class="text-blue-700">Follow these steps to automatically save quiz results to Google Sheets:</p>
            </div>
            <div class="space-y-4">
              <div class="border-l-4 border-green-500 pl-4">
                <h4 class="font-bold text-lg">Step 1: Create a Google Sheet</h4>
                <p>1. Go to <a href="https://sheets.google.com" target="_blank" class="text-blue-600 underline">Google Sheets</a></p>
                <p>2. Create a new blank spreadsheet</p>
                <p>3. Name it "Quiz Results"</p>
              </div>
              <div class="border-l-4 border-blue-500 pl-4">
                <h4 class="font-bold text-lg">Step 2: Open Google Apps Script</h4>
                <p>1. In your sheet, go to <strong>Extensions ‚Üí Apps Script</strong></p>
                <p>2. Delete any existing code in the editor</p>
                <p>3. Copy and paste <b>the code below</b>:</p>
              </div>
              <div class="bg-gray-100 p-4 rounded-lg">
                <h5 class="font-bold mb-2">Google Apps Script Code:</h5>
                <textarea readonly class="w-full h-64 p-3 bg-white border rounded font-mono text-sm" onclick="this.select()">function doPost(e) {
  try {
    const sheet = SpreadsheetApp.getActiveSheet();
    const data = JSON.parse(e.postData.contents);
    if (sheet.getLastRow() === 0) {
      const headers = [
        'Timestamp', 'Name', 'Email', 'Phone', 'Address', 
        'Score', 'Total Questions', 'Percentage', 'Completion Status'
      ];
      for (let i = 0; i < data.totalQuestions; i++) {
        headers.push(`Q${i + 1} Answer`, `Q${i + 1} Correct`, `Q${i + 1} Time Used`);
      }
      sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
    }
    const row = [
      new Date(data.completedAt),
      data.participant.name,
      data.participant.email,
      data.participant.phone,
      data.participant.address || 'N/A',
      data.score,
      data.totalQuestions,
      Math.round((data.score / data.totalQuestions) * 100) + '%',
      data.answers.length === data.totalQuestions ? 'Complete' : 'Incomplete'
    ];
    data.answers.forEach(answer => {
      row.push(
        answer.skipped ? 'Skipped' : answer.selectedOption || 'N/A',
        answer.correct ? 'Yes' : 'No',
        answer.timeUsed + 's'
      );
    });
    sheet.appendRow(row);
    return ContentService
      .createTextOutput(JSON.stringify({success: true, message: 'Data saved successfully'}))
      .setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    return ContentService
      .createTextOutput(JSON.stringify({success: false, error: error.toString()}))
      .setMimeType(ContentService.MimeType.JSON);
  }
}
function doGet(e) {
  return ContentService
    .createTextOutput(JSON.stringify({success: true, message: 'Quiz API is working'}))
    .setMimeType(ContentService.MimeType.JSON);
}</textarea>
              </div>
              <div class="border-l-4 border-purple-500 pl-4">
                <h4 class="font-bold text-lg">Step 3: Deploy the Script</h4>
                <p>1. Click <strong>Deploy ‚Üí New deployment</strong></p>
                <p>2. Set <strong>Type:</strong> Web app</p>
                <p>3. Set <strong>Execute as:</strong> Me</p>
                <p>4. Set <strong>Who has access:</strong> Anyone</p>
                <p>5. Deploy and copy your <b>Web app URL</b></p>
              </div>
              <div class="border-l-4 border-orange-500 pl-4">
                <h4 class="font-bold text-lg">Step 4: Configure Quiz</h4>
                <p>1. Paste the Web app URL in the "Google Sheets Web App URL" field</p>
                <p>2. Click "Test Connection" to verify</p>
                <p>3. Save quiz settings</p>
              </div>
              <div class="bg-green-50 p-4 rounded-lg">
                <h4 class="font-bold text-green-800">‚úÖ That's it!</h4>
                <p class="text-green-700">All quiz results will be saved to your Google Sheet in real time.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
<script>
/* ---------- Quiz Data and State ---------- */
let quizData = {
  title: "Knowledge Challenge Quiz",
  timer: 10,
  requirePostal: false,
  endDate: "2024-12-31",
  endTime: "23:59",
  questions: [
    {
      question: "What is the capital of France?",
      options: ["London", "Berlin", "Paris", "Madrid"],
      correct: 2
    },
    {
      question: "Which planet is known as the Red Planet?",
      options: ["Venus", "Mars", "Jupiter", "Saturn"],
      correct: 1
    },
    {
      question: "What is 2 + 2?",
      options: ["3", "4", "5", "6"],
      correct: 1
    },
    {
      question: "Who painted the Mona Lisa?",
      options: ["Van Gogh", "Picasso", "Da Vinci", "Monet"],
      correct: 2
    },
    {
      question: "What is the largest ocean on Earth?",
      options: ["Atlantic", "Indian", "Arctic", "Pacific"],
      correct: 3
    }
  ]
};

let currentQuestion = 0;
let selectedAnswer = null;
let timer = null;
let timeLeft = quizData.timer;
let answers = [];
let participantData = {};
let quizResults = JSON.parse(localStorage.getItem('quizResults') || '[]');
let googleSheetsUrl = localStorage.getItem('googleSheetsUrl') || '';

const ADMIN_PASSWORD = 'KARNATAKA1&mate';

/* ---------- UI Navigation Functions ---------- */

function showAdminLogin() {
  document.getElementById('adminLoginModal').classList.remove('hidden');
}

function closeAdminLogin() {
  document.getElementById('adminLoginModal').classList.add('hidden');
  document.getElementById('adminPassword').value = '';
}

function toggleAdminPortal() {
  const portal = document.getElementById('adminPortal');
  portal.classList.toggle('hidden');
  if (!portal.classList.contains('hidden')) {
    loadAdminData();
  }
}

function showGoogleSheetsSetup() {
  document.getElementById('googleSheetsModal').classList.remove('hidden');
}

function closeGoogleSheetsModal() {
  document.getElementById('googleSheetsModal').classList.add('hidden');
}

function closeResultsModal() {
  document.getElementById('resultsModal').classList.add('hidden');
}

/* ---------- Quiz Flow Functions ---------- */

function startQuiz() {
  document.getElementById('welcomeScreen').classList.add('hidden');
  document.getElementById('registrationScreen').classList.remove('hidden');
}

document.getElementById('registrationForm').addEventListener('submit', function(e) {
  e.preventDefault();
  participantData = {
    name: document.getElementById('participantName').value,
    email: document.getElementById('participantEmail').value,
    phone: document.getElementById('participantPhone').value,
    address: quizData.requirePostal ? document.getElementById('participantAddress').value : null
  };
  showQuestion();
});

function showQuestion() {
  document.getElementById('registrationScreen').classList.add('hidden');
  document.getElementById('questionScreen').classList.remove('hidden');

  loadQuestion();
  startTimer();
}

function loadQuestion() {
  const q = quizData.questions[currentQuestion];
  document.getElementById('currentQuestionNum').textContent = currentQuestion + 1;
  document.getElementById('totalQuestions').textContent = quizData.questions.length;
  document.getElementById('questionText').textContent = q.question;

  const container = document.getElementById('optionsContainer');
  container.innerHTML = "";
  q.options.forEach((opt, index) => {
    const btn = document.createElement('button');
    btn.textContent = opt;
    btn.className = "block w-full text-left bg-white text-black px-4 py-2 rounded hover:bg-gray-200";
    btn.onclick = () => {
      selectedAnswer = index;
      [...container.children].forEach(c => c.classList.remove("bg-blue-300"));
      btn.classList.add("bg-blue-300");
    };
    container.appendChild(btn);
  });

  selectedAnswer = null;
  document.getElementById('timeLeft').textContent = quizData.timer;
}

function startTimer() {
  clearInterval(timer);
  timeLeft = quizData.timer;

  timer = setInterval(() => {
    timeLeft--;
    document.getElementById('timeLeft').textContent = timeLeft;
    if (timeLeft <= 3) {
      document.getElementById('timerDisplay').classList.add('timer-warning');
    } else {
      document.getElementById('timerDisplay').classList.remove('timer-warning');
    }
    if (timeLeft <= 0) {
      clearInterval(timer);
      skipQuestion();
    }
  }, 1000);
}

function submitAnswer() {
  if (selectedAnswer === null) {
    showPopup();
    return;
  }
  const correct = quizData.questions[currentQuestion].correct === selectedAnswer;
  answers.push({ answer: selectedAnswer, correct, skipped: false, timeUsed: quizData.timer - timeLeft });

  nextQuestion();
}

function skipQuestion() {
  answers.push({ answer: null, correct: false, skipped: true, timeUsed: quizData.timer - timeLeft });
  nextQuestion();
}

function nextQuestion() {
  clearInterval(timer);
  currentQuestion++;
  if (currentQuestion >= quizData.questions.length) {
    finishQuiz();
  } else {
    loadQuestion();
    startTimer();
  }
}

function finishQuiz() {
  document.getElementById('questionScreen').classList.add('hidden');
  document.getElementById('thankYouScreen').classList.remove('hidden');

  const endDate = new Date(quizData.endDate + 'T' + quizData.endTime);
  const options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
  document.getElementById('certificateDate').textContent = endDate.toLocaleDateString('en-US', options);

  const results = {
    participant: participantData,
    answers: answers,
    score: answers.filter(a => a.correct).length,
    totalQuestions: quizData.questions.length,
    completedAt: new Date().toISOString()
  };

  quizResults.push(results);
  localStorage.setItem('quizResults', JSON.stringify(quizResults));

  saveToGoogleSheets(results);

  console.log("Quiz Results Saved:", results);
}

function showPopup() {
  document.getElementById('popupModal').classList.remove('hidden');
}
function closePopup() {
  document.getElementById('popupModal').classList.add('hidden');
}
function restartQuiz() {
  currentQuestion = 0;
  selectedAnswer = null;
  answers = [];
  participantData = {};
  document.getElementById('questionScreen').classList.add('hidden');
  document.getElementById('registrationScreen').classList.add('hidden');
  document.getElementById('thankYouScreen').classList.add('hidden');
  document.getElementById('welcomeScreen').classList.remove('hidden');
  document.getElementById('registrationForm').reset();
}

/* ---------- Admin Portal Logic ---------- */
// Admin login form handler
document.getElementById('adminLoginForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const password = document.getElementById('adminPassword').value;
  if (password === ADMIN_PASSWORD) {
    closeAdminLogin();
    toggleAdminPortal();
  } else {
    alert('‚ùå Incorrect password. Please try again.');
    document.getElementById('adminPassword').value = '';
    document.getElementById('adminPassword').focus();
  }
});

function loadAdminData() {
  document.getElementById('quizTitle').value = quizData.title;
  document.getElementById('questionTimer').value = quizData.timer;
  document.getElementById('endDate').value = quizData.endDate;
  document.getElementById('endTime').value = quizData.endTime;
  document.getElementById('requirePostalAddress').checked = quizData.requirePostal;
  document.getElementById('googleSheetsUrl').value = googleSheetsUrl;
  loadQuestions();
  updateResultsStats();
}

function saveQuizSettings() {
  quizData.title = document.getElementById('quizTitle').value;
  quizData.timer = parseInt(document.getElementById('questionTimer').value);
  quizData.endDate = document.getElementById('endDate').value;
  quizData.endTime = document.getElementById('endTime').value;
  quizData.requirePostal = document.getElementById('requirePostalAddress').checked;
  googleSheetsUrl = document.getElementById('googleSheetsUrl').value.trim();
  localStorage.setItem('googleSheetsUrl', googleSheetsUrl);

  alert('‚úÖ Quiz settings saved!');
}

function previewQuiz() {
  toggleAdminPortal();
  restartQuiz();
}

function addQuestion() {
  quizData.questions.push({
    question: "",
    options: ["", "", "", ""],
    correct: 0
  });
  loadQuestions();
}

function loadQuestions() {
  const container = document.getElementById('questionsContainer');
  container.innerHTML = "";
  quizData.questions.forEach((q, idx) => {
    const group = document.createElement('div');
    group.className = "bg-white p-4 rounded shadow space-y-2";
    group.innerHTML = `
      <label class="block font-bold mb-1">Q${idx + 1}</label>
      <input type="text" class="w-full p-2 border rounded mb-2" placeholder="Question..." value="${q.question}" onchange="quizData.questions[${idx}].question = this.value">
      <div class="grid grid-cols-2 gap-2">
        <input type="text" class="p-2 border rounded" placeholder="Option 1" value="${q.options[0]}" onchange="quizData.questions[${idx}].options[0]=this.value">
        <input type="text" class="p-2 border rounded" placeholder="Option 2" value="${q.options[1]}" onchange="quizData.questions[${idx}].options[1]=this.value">
        <input type="text" class="p-2 border rounded" placeholder="Option 3" value="${q.options[2]}" onchange="quizData.questions[${idx}].options[2]=this.value">
        <input type="text" class="p-2 border rounded" placeholder="Option 4" value="${q.options[3]}" onchange="quizData.questions[${idx}].options[3]=this.value">
      </div>
      <div>
        <label class="mr-2">Correct:</label>
        <select class="border rounded p-1" onchange="quizData.questions[${idx}].correct = parseInt(this.value)">
          <option value="0" ${q.correct===0?'selected':''}>1</option>
          <option value="1" ${q.correct===1?'selected':''}>2</option>
          <option value="2" ${q.correct===2?'selected':''}>3</option>
          <option value="3" ${q.correct===3?'selected':''}>4</option>
        </select>
        <button onclick="quizData.questions.splice(${idx},1); loadQuestions();" class="ml-4 bg-red-500 text-white px-3 py-1 rounded">Delete</button>
      </div>
    `;
    container.appendChild(group);
  });
}

/* ---------- Results, Analytics, Export ---------- */

function updateResultsStats() {
  const totalParticipants = quizResults.length;
  const completedQuizzes = quizResults.filter(r => r.answers.length === quizData.questions.length);
  const averageScore = completedQuizzes.length > 0 ?
    Math.round((completedQuizzes.reduce((sum, r) => sum + r.score, 0) / completedQuizzes.length / quizData.questions.length) * 100) : 0;
  const completionRate = totalParticipants > 0 ? Math.round((completedQuizzes.length / totalParticipants) * 100) : 0;

  document.getElementById('totalParticipants').textContent = totalParticipants;
  document.getElementById('averageScore').textContent = averageScore + '%';
  document.getElementById('completionRate').textContent = completionRate + '%';
}

function viewResults() {
  const modal = document.getElementById('resultsModal');
  const content = document.getElementById('resultsContent');
  
  if (quizResults.length === 0) {
    content.innerHTML = `
      <div class="text-center py-12">
        <div class="text-6xl mb-4">üìä</div>
        <h3 class="text-xl font-bold mb-2">No Results Yet</h3>
        <p class="text-gray-600">Quiz results will appear here once participants complete the quiz.</p>
      </div>
    `;
  } else {
    content.innerHTML = `
      <div class="overflow-x-auto">
        <table class="w-full border-collapse border border-gray-300">
          <thead>
            <tr class="bg-gray-100">
              <th class="border border-gray-300 px-4 py-2 text-left">Name</th>
              <th class="border border-gray-300 px-4 py-2 text-left">Email</th>
              <th class="border border-gray-300 px-4 py-2 text-left">Phone</th>
              ${quizData.requirePostal ? '<th class="border border-gray-300 px-4 py-2 text-left">Address</th>' : ''}
              <th class="border border-gray-300 px-4 py-2 text-center">Score</th>
              <th class="border border-gray-300 px-4 py-2 text-center">Completion</th>
              <th class="border border-gray-300 px-4 py-2 text-center">Date</th>
              <th class="border border-gray-300 px-4 py-2 text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            ${quizResults.map((result, index) => `
                <tr class="hover:bg-gray-50">
                  <td class="border border-gray-300 px-4 py-2">${result.participant.name}</td>
                  <td class="border border-gray-300 px-4 py-2">${result.participant.email}</td>
                  <td class="border border-gray-300 px-4 py-2">${result.participant.phone}</td>
                  ${quizData.requirePostal ? `<td class="border border-gray-300 px-4 py-2">${result.participant.address || 'N/A'}</td>` : ''}
                  <td class="border border-gray-300 px-4 py-2 text-center">
                    <span class="font-bold ${result.score >= quizData.questions.length * 0.7 ? 'text-green-600' : result.score >= quizData.questions.length * 0.5 ? 'text-orange-600' : 'text-red-600'}">
                      ${result.score}/${result.totalQuestions}
                    </span>
                  </td>
                  <td class="border border-gray-300 px-4 py-2 text-center">
                    <span class="px-2 py-1 rounded text-xs ${result.answers.length === result.totalQuestions ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                      ${result.answers.length === result.totalQuestions ? 'Complete' : 'Incomplete'}
                    </span>
                  </td>
                  <td class="border border-gray-300 px-4 py-2 text-center text-sm">
                    ${new Date(result.completedAt).toLocaleDateString()}
                  </td>
                  <td class="border border-gray-300 px-4 py-2 text-center">
                    <button onclick="viewDetailedResult(${index})" class="bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600">
                      Details
                    </button>
                  </td>
                </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    `;
  }
  modal.classList.remove('hidden');
}

function viewDetailedResult(index) {
  const result = quizResults[index];
  const content = document.getElementById('resultsContent');
  
  content.innerHTML = `
    <div class="space-y-6">
      <div class="flex justify-between items-center">
        <h3 class="text-xl font-bold">Detailed Results for ${result.participant.name}</h3>
        <button onclick="viewResults()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
          ‚Üê Back to All Results
        </button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="bg-gray-50 p-4 rounded-lg">
          <h4 class="font-semibold mb-3">Participant Info</h4>
          <p><strong>Name:</strong> ${result.participant.name}</p>
          <p><strong>Email:</strong> ${result.participant.email}</p>
          <p><strong>Phone:</strong> ${result.participant.phone}</p>
          ${result.participant.address ? `<p><strong>Address:</strong> ${result.participant.address}</p>` : ''}
          <p><strong>Completed:</strong> ${new Date(result.completedAt).toLocaleString()}</p>
        </div>
        <div class="bg-gray-50 p-4 rounded-lg">
          <h4 class="font-semibold mb-3">Performance Summary</h4>
          <p><strong>Score:</strong> ${result.score}/${result.totalQuestions} (${Math.round((result.score/result.totalQuestions)*100)}%)</p>
          <p><strong>Questions Answered:</strong> ${result.answers.length}/${result.totalQuestions}</p>
          <p><strong>Correct Answers:</strong> ${result.answers.filter(a => a.correct).length}</p>
          <p><strong>Skipped:</strong> ${result.answers.filter(a => a.skipped).length}</p>
        </div>
      </div>
      <div class="bg-gray-50 p-4 rounded-lg">
        <h4 class="font-semibold mb-3">Question-by-Question Analysis</h4>
        <div class="space-y-3">
          ${result.answers.map((answer, qIndex) => {
            const question = quizData.questions[qIndex];
            return `
              <div class="border border-gray-200 rounded p-3 ${answer.correct ? 'bg-green-50' : answer.skipped ? 'bg-yellow-50' : 'bg-red-50'}">
                <div class="flex justify-between items-start mb-2">
                  <p class="font-medium">Q${qIndex + 1}: ${question.question}</p>
                  <span class="px-2 py-1 rounded text-xs ${answer.correct ? 'bg-green-200 text-green-800' : answer.skipped ? 'bg-yellow-200 text-yellow-800' : 'bg-red-200 text-red-800'}">
                    ${answer.correct ? 'Correct' : answer.skipped ? 'Skipped' : 'Wrong'}
                  </span>
                </div>
                <p class="text-sm text-gray-600">
                  <strong>Participant's Answer:</strong> ${answer.skipped ? 'Skipped' : question.options[answer.answer]}
                </p>
                <p class="text-sm text-gray-600">
                  <strong>Correct Answer:</strong> ${question.options[question.correct]}
                </p>
                <p class="text-sm text-gray-600">
                  <strong>Time Used:</strong> ${answer.timeUsed || 0}s
                </p>
              </div>
            `;
          }).join('')}
        </div>
      </div>
    </div>
  `;
}

/* ---------- Google Sheets Integration ---------- */

function testGoogleSheets() {
  const url = document.getElementById('googleSheetsUrl').value;
  if (!url) {
    alert('Please enter a Google Sheets Web App URL first.');
    return;
  }
  fetch(url)
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('‚úÖ Connection successful! Your Google Sheets integration is working.');
      } else {
        alert('‚ùå Connection failed. Please check your URL and try again.');
      }
    })
    .catch(error => {
      alert('‚ùå Connection failed: ' + error.message + '\n\nPlease check your Google Apps Script setup.');
    });
}

async function saveToGoogleSheets(results) {
  if (!googleSheetsUrl) {
    console.log('Google Sheets URL not configured, skipping cloud save');
    return;
  }
  try {
    const dataToSend = {
      ...results,
      answers: results.answers.map((answer, index) => ({
        ...answer,
        questionText: quizData.questions[index]?.question || 'Unknown Question',
        selectedOption: answer.skipped ? 'Skipped' :
                        (answer.answer !== null ? quizData.questions[index]?.options[answer.answer] : 'No Answer')
      }))
    };
    const response = await fetch(googleSheetsUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(dataToSend)
    });
    const result = await response.json();
    if (result.success) {
      console.log('‚úÖ Results successfully saved to Google Sheets');
    } else {
      console.error('‚ùå Failed to save to Google Sheets:', result.error);
    }
  } catch (error) {
    console.error('‚ùå Error saving to Google Sheets:', error);
  }
}

/* ---------- Result Export and Delete ---------- */
function exportResults() {
  if (!quizResults.length) { alert('No results to export.'); return; }
  let rows = [
    ["Name", "Email", "Phone", "Score", "Total Questions", "Completion", "Completed At"]
  ];
  quizResults.forEach(r => {
    rows.push([
      r.participant.name,
      r.participant.email,
      r.participant.phone,
      r.score,
      r.totalQuestions,
      r.answers.length === r.totalQuestions ? 'Complete' : 'Incomplete',
      r.completedAt
    ]);
  });
  let csvContent = "data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n");
  const encodedUri = encodeURI(csvContent);
  let link = document.createElement("a");
  link.setAttribute("href", encodedUri);
  link.setAttribute("download", "quiz_results.csv");
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

function clearResults() {
  if (confirm('Are you sure you want to delete all quiz results?')) {
    quizResults = [];
    localStorage.setItem('quizResults', JSON.stringify(quizResults));
    updateResultsStats();
    alert('All results cleared.');
  }
}

/* ---------- Misc ---------- */
function updateWelcomeScreen() {
  document.getElementById('welcomeTitle').textContent = "üß† " + quizData.title;
}

// Set default end date to next month
const nextMonth = new Date();
nextMonth.setMonth(nextMonth.getMonth() + 1);
quizData.endDate = nextMonth.toISOString().split('T')[0];
quizData.endTime = "23:59";
updateWelcomeScreen();

</script>
</body>
</html>
